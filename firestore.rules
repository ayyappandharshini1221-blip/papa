rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper functions
    function isAuth() {
      return request.auth != null;
    }
    
    function isStudent() {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student';
    }
    
    function isTeacher() {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }

    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    // USERS collection
    match /users/{userId} {
      // Anyone can create a user profile (sign up)
      allow create: if isAuth();

      // Users can read their own profile.
      // Teachers can read the profiles of students in their classes.
      allow read: if isOwner(userId) || 
                  (isTeacher() && 
                    get(/databases/$(database)/documents/users/$(userId)).data.role == 'student' &&
                    // Check if a class exists where the teacher is the teacher and the student is enrolled.
                    exists(/databases/$(database)/documents/classes/{classId} where 
                      get(/databases/$(database)/documents/classes/{classId}).data.teacherId == request.auth.uid && 
                      userId in get(/databases/$(database)/documents/classes/{classId}).data.studentIds));

      // Users can only update their own profile.
      // Students can update their name, xp, streak, badges, and join classes.
      // Teachers can update their name.
      // Role cannot be changed.
      allow update: if isOwner(userId) && request.resource.data.role == resource.data.role;
      
      // Users can only delete their own account
      allow delete: if isOwner(userId);
    }
    
    // CLASSES collection
    match /classes/{classId} {
      // Only teachers can create new classes
      allow create: if isTeacher() && request.resource.data.teacherId == request.auth.uid;
      
      // Allow read if the user is the teacher of the class or a student in it.
      allow read: if isAuth() && (
                    resource.data.teacherId == request.auth.uid || 
                    request.auth.uid in resource.data.studentIds
                  );
      
      // Only the teacher of a class can update it (e.g. change name)
      // Students cannot modify class documents directly. Student enrollment is handled via user document update.
      allow update: if isTeacher() && resource.data.teacherId == request.auth.uid;
      
      // Only the teacher can delete a class
      allow delete: if isTeacher() && resource.data.teacherId == request.auth.uid;
    }
  }
}
